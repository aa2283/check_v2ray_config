- name: Run subscription checker
        run: |
          # 1. 准备环境
          mkdir -p ${{ github.workspace }}/output
          mkdir -p ${{ github.workspace }}/temp_config
          chmod -R 777 ${{ github.workspace }}/output

          # 2. 注入 Secret (剔除 README.md 后剩下的 26 条)
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          
          python3 -c "
          import os
          template_path = '${{ github.workspace }}/config/config.yaml'
          output_path = '${{ github.workspace }}/temp_config/config.yaml'
          
          with open(template_path, 'r', encoding='utf-8') as f:
              lines = f.readlines()
          
          raw_urls = os.environ.get('RAW_URLS_DATA', '').strip().split('\n')
          # 过滤掉空行和可能残留的 README 链接
          clean_urls = [u.strip() for u in raw_urls if u.strip() and 'README.md' not in u]
          
          new_lines = []
          for line in lines:
              if '{SUB_URLS}' in line:
                  for url in clean_urls:
                      # 关键：给 URL 加上双引号，防止 YAML 解析报错
                      new_lines.append(f'  - \"{url}\"\n')
              else:
                  new_lines.append(line)
          
          with open(output_path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          "
          echo ">>> 已注入 ${{ secrets.SUB_URLS != '' && '26' || '0' }} 条链接，已强制添加双引号保护。"

          # 3. 智能观察者
          (
            echo ">>> [观察者] 监控启动..."
            TIMER_STARTED=false 
            while true; do
              sleep 20
              if ! docker ps | grep -q "checker"; then break; fi
              
              LOG_RAW=$(docker logs checker 2>&1 | tail -n 10 | sed 's/\x1b\[[0-9;]*m//g')
              
              if echo "$LOG_RAW" | grep -q "保存本地成功"; then
                echo ">>> [观察者] 任务完成。"
                docker stop checker
                break
              fi

              if [[ "$TIMER_STARTED" = false ]] && echo "$LOG_RAW" | grep -q "100.0%"; then
                TIMER_STARTED=true
                echo ">>> [观察者] 进度 100%，给 5 分钟缓冲存盘..."
                (sleep 300; docker stop checker || true) &
              fi
            done
          ) &

          # 4. 运行
          docker run --name checker --rm -i --init \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
