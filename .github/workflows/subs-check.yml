name: Subscription Checker

on:
  schedule:
    - cron: '15 4 * * *'  # 每天北京时间 12:15 运行
  workflow_dispatch:      # 支持手动点击运行

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run subscription checker
        run: |
          # 0. 准备输出目录
          mkdir -p ${{ github.workspace }}/output
          chmod -R 777 ${{ github.workspace }}/output

          # 1. 智能守护监听器 (解决卡在 100.0% 的问题)
          (
            echo ">>> [观察者] 已启动，正在监控任务状态..."
            WAS_HUNDRED=false
            
            while true; do
              sleep 10  # 每 10 秒扫描一次日志
              
              # 获取最后几行日志并去除 ANSI 颜色干扰字符
              LOG_TAIL=$(docker logs checker 2>&1 | tail -n 5 | sed 's/\x1b\[[0-9;]*m//g')
              
              # 情况 A: 正常探测到程序输出“保存本地成功”
              if echo "$LOG_TAIL" | grep -q "保存本地成功"; then
                echo -e "\n[观察者] 捕获到程序自然存盘信号，正在解锁流程..."
                docker stop checker
                break
              fi

              # 情况 B: 进度达到 100.0%，开启 3 分钟倒计时缓冲
              if [[ "$WAS_HUNDRED" = false ]] && echo "$LOG_TAIL" | grep -q "100.0%"; then
                echo -e "\n[观察者] 检测到进度已达 100.0%，开启 3 分钟最终宽限时间，等待收尾..."
                WAS_HUNDRED=true
                # 在后台异步执行倒计时
                (
                  sleep 180
                  if docker ps | grep -q "checker"; then
                    echo -e "\n[观察者] 3 分钟宽限期满，强制收割残留进程..."
                    docker stop checker
                  fi
                ) &
              fi

              # 如果容器已经自然退出，观察者也退出
              if ! docker ps | grep -q "checker"; then break; fi
            done
          ) &

          # 2. 正式运行容器 (TTY 模式保证过程显示)
          echo ">>> 正在启动检测引擎 (实时进度模式)..."
          docker run --name checker --rm -t \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            -e SUB_URLS="${{ secrets.SUB_URLS }}" \
            ghcr.io/aa2283/subs-check:master || echo ">>> 容器运行结束。"

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: aa2283/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo

      - name: Copy and commit changes
        run: |
          cd target-repo
          
          # 1. 建立子目录 (如果不存在)
          mkdir -p sub
          
          # 2. 清理旧文件：只清理 sub/ 文件夹内部的文件，不影响仓库根目录或其他文件夹
          # 这样可以保证这个任务只管自己的 sub 目录
          find sub/ -maxdepth 1 ! -name "sub/" ! -name "." -exec rm -rf {} +
          
          # 3. 同步最新生成的文件到 sub 文件夹中
          cp -rv ../output/* sub/ || echo ">>> 未发现新生成的文件"
          
          # 4. 配置 Git 并提交
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add -A
          # 这里的提交信息可以改得更具体一些
          git commit -m "自动更新订阅：同步至 sub 子目录" || echo ">>> 内容无变更，跳过推送"
          
          git push
